---
title: Стандартный блок привязок ДАПР
description: Описание стандартного блока привязок, его функций, преимуществ и способов применения
author: edwinvw
ms.date: 02/07/2021
ms.openlocfilehash: 757d2560016407119fe9244c100a971977852cc5
ms.sourcegitcommit: bdbf6472de867a0a11aaa5b9384a2506c24f27d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102401889"
---
# <a name="the-dapr-bindings-building-block"></a>Стандартный блок привязок ДАПР

Облачные предложения *,* такие как функции Azure и AWS лямбда-выражения, имеют широкое внедрение в пространстве распределенной архитектуры. Помимо многих преимуществ, они позволяют микрослужбам *управлять событиями* или *вызывать события во* внешней системе, разрешающей базовые трудности и связанные с ними проблемы. Внешние ресурсы — это многие из них: хранилища данных, системы сообщений и веб-ресурсы на разных платформах и поставщиках. [Стандартный блок привязок ДАПР](https://docs.dapr.io/developing-applications/building-blocks/bindings/bindings-overview/) предоставляет эти же возможности привязки ресурсов в прибывают приложений ДАПР.

## <a name="what-it-solves"></a>Решение

Привязки ресурсов ДАПР позволяют службам интегрировать бизнес-операции во внешних ресурсах за пределами немедленного приложения. Событие внешней системы может активировать операцию в службе, передавая контекстные сведения. Затем служба может расширить операцию, активируя событие в другой внешней системе, передавая контекстные полезные данные. Служба взаимодействует без связи или осведомленности о внешнем ресурсе. Эти коммуникации инкапсулируются внутри предварительно определенных компонентов ДАПР. Используемый компонент ДАПР можно легко поменять местами во время выполнения без изменения кода.

Рассмотрим, например, учетную запись Twitter, которая запускает событие каждый раз, когда пользователь твитет ключевое слово. Служба предоставляет обработчик событий, который получает и обрабатывает твит. После завершения служба активирует событие, вызывающее внешнюю службу Twilio. Twilio отправляет сообщение SMS, содержащее твит. На рис. 8-1 показана концептуальная архитектура этой операции.

![Входная привязка](media/bindings/bindings-architecture.png)

**Рис. 8-1**. Концептуальная архитектура привязки ресурсов ДАПР.

На первый взгляд поведение привязки ресурсов может показаться похожим на [шаблон публикации или подписки](publish-subscribe.md) , описанный ранее в этой книге. Хотя они имеют сходство, существуют различия. Публикация/подписка фокусируется на асинхронной связи между ДАПР Services. Привязка ресурсов имеет намного более широкие области. В нем основное внимание уделяется взаимодействию системы на разных платформах программного обеспечения. Обмен данными между разнородными приложениями, хранилищами данных и службами за пределами приложения микрослужбы.

## <a name="how-it-works"></a>Принцип работы

Привязка ресурса ДАПР начинается с файла конфигурации компонента. Этот файл YAML описывает тип ресурса, с которым будет осуществляться привязка, и его параметры конфигурации. После настройки Служба может получить события от ресурса или события триггера.

> [!NOTE]
> Конфигурации привязки представлены подробно далее в разделе *компоненты* .

### <a name="input-bindings"></a>Входные привязки

Входные привязки активируют код с входящими событиями из внешних ресурсов. Чтобы получить события и данные, необходимо зарегистрировать общедоступную конечную точку из службы, которая станет *обработчиком событий*. На рис. 8-2 показан поток:

![Поток привязки ввода ДАПР](media/bindings/input-binding-flow.png)

**Рис. 8-2**. Поток привязки ввода ДАПР.

На рис. 8,2 описаны действия по получению событий из внешней учетной записи Twitter.

1. ДАПР расширения считывает файл конфигурации привязки и подписывается на событие, указанное для внешнего ресурса. В этом примере источником события является учетная запись Twitter.
1. Когда соответствующий твит публикуется в Twitter, компонент привязки, выполняющийся в ДАПР расширения, выбирает его и активирует событие.
1. ДАПР расширения вызывает конечную точку (то есть обработчик событий), настроенную для привязки. В этом примере служба прослушивает HTTP-запрос POST на `/tweet` конечной точке через порт 6000. Так как это операция HTTP POST, полезные данные JSON для события передаются в тексте запроса.
1. После обработки события служба возвращает код состояния HTTP `200 OK` .

Следующий контроллер ASP.NET Core предоставляет пример обработки события, запускаемого привязкой Twitter:

```csharp
[ApiController]
public class SomeController : ControllerBase
{
    public class TwitterTweet
    {
        [JsonPropertyName("id_str")]
        public string ID {get; set; }

        [JsonPropertyName("text")]
        public string Text {get; set; }
    }

    [HttpPost("/tweet")]
    public ActionResult Post(TwitterTweet tweet)
    {
        // Handle tweet
        Console.WriteLine("Tweet received: {0}: {1}", tweet.ID, tweet.Text);

        // ...

        // Acknowledge message
        return Ok();
    }
}
```

Если операция должна возвращать ошибку, возвращается соответствующий код состояния HTTP уровня 400 или 500. Для привязок, которые имеют гарантии *по крайней мере однократной доставки* , ДАПР расширения будет повторять триггер. Ознакомьтесь с [ДАПР документацией по привязкам ресурсов] [1], чтобы узнать, предлагают ли они гарантии доставки *по крайней мере один* раз или *ровно один раз* .

### <a name="output-bindings"></a>Выходные привязки

ДАПР также включает возможности *выходной привязки* . Они позволяют службе активировать событие, вызывающее внешний ресурс. Опять же, сначала нужно настроить файл конфигурации привязки YAML, описывающий выходную привязку. После этого вы активируете событие, которое вызывает API привязок в ДАПР расширения приложения. На рисунке 8-3 показан поток выходной привязки.

![Поток привязки выходных данных ДАПР](media/bindings/output-binding-flow.png)

**Рис. 8-3**. Поток привязки выходных данных ДАПР.

1. ДАПР расширения считывает файл конфигурации привязки со сведениями о том, как подключиться к внешнему ресурсу. В этом примере внешний ресурс является Twilio учетной записью SMS.
1. Приложение вызывает `/v1.0/bindings/sms` конечную точку в ДАПР расширения. В этом случае для вызова API используется HTTP-запрос POST. Также можно использовать gRPC.
1. Компонент привязки, выполняющийся в ДАПР расширения, вызывает внешнюю систему обмена сообщениями для отправки сообщения. Сообщение будет содержать полезные данные, переданные в запрос POST.

Например, можно вызвать выходную привязку, вызвав API ДАПР, используя фигурную скобку:

```console
curl -X POST http://localhost:3500/v1.0/bindings/sms \
  -H "Content-Type: application/json" \
  -d '{
        "data": "Welcome to this awesome service",
        "metadata": {
          "toNumber": "555-3277"
        },
        "operation": "create"
      }'
```

Обратите внимание, что HTTP-порт совпадает с используемым расширенияом ДАПР (в данном случае HTTP-портом ДАПР по умолчанию `3500` ).

Структура полезных данных (то есть отправленное сообщение) будет отличаться для каждой привязки. В приведенном выше примере полезная нагрузка содержит `data` элемент с сообщением. Привязки к другим типам внешних ресурсов могут отличаться, особенно для отправленных метаданных. Каждая полезная нагрузка должна также содержать `operation` поле, определяющее операцию, которую будет выполнять привязка. В приведенном выше примере указывается `create` операция, создающая SMS-сообщение. К общим операциям относятся:

- create
- get
- удалить
- list

Это может быть автор привязки, который поддерживает привязка. В документации по каждой привязке описаны доступные операции и способы их вызова.

## <a name="using-the-dapr-net-sdk"></a>Использование пакета SDK для ДАПР .NET

Пакет SDK для ДАПР для .NET предоставляет поддержку для разработчиков .NET Core на определенном языке. В следующем примере вызов `HttpClient.PostAsync()` метода заменяется на `DaprClient.InvokeBindingAsync()` метод. Этот специализированный метод упрощает вызов настроенной выходной привязки.

```csharp
private async Task SendSMSAsync([FromServices] DaprClient daprClient)
{
    var message = "Welcome to this awesome service";
    var metadata = new Dictionary<string, string>
    {
      { "toNumber", "555-3277" }
    };
    await daprClient.InvokeBindingAsync("sms", "create", message, metadata);
}
```

Метод принимает `metadata` `message` значения и.

При использовании для вызова привязки `DaprClient` компонент использует gRPC для вызова API ДАПР в ДАПР расширения.

## <a name="binding-components"></a>Привязка компонентов

На внутреннем ресурсе привязки ресурсов реализуются с помощью компонентов привязки ДАПР. Они предоставляются сообществом и пишутся в дороге. Если необходимо выполнить интеграцию с внешним ресурсом, для которого не существует привязки ДАПР, можно создать его самостоятельно. Чтобы узнать, как можно привязать привязку, ознакомьтесь с [репозиторием ДАПР Components-от участников сообщества](https://github.com/dapr/components-contrib) .

> [!NOTE]
> ДАПР и все его компоненты написаны на языке [Golang](https://golang.org/) (Go). Go считается современной облачной платформой программирования.

Привязки настраиваются с помощью файла конфигурации YAML. Ниже приведен пример конфигурации для привязки Twitter.

```yaml
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: twitter-mention
  namespace: default
spec:
  type: bindings.twitter
  version: v1
  metadata:
  - name: consumerKey
    value: "****" # twitter api consumer key, required
  - name: consumerSecret
    value: "****" # twitter api consumer secret, required
  - name: accessToken
    value: "****" # twitter api access token, required
  - name: accessSecret
    value: "****" # twitter api access secret, required
  - name: query
    value: "dapr" # your search query, required
```

Каждая конфигурация привязки содержит общий `metadata` элемент с `name` `namespace` полем и. ДАПР определит конечную точку для вызова службы на основе настроенного `name` поля. В приведенном выше примере ДАПР вызовет метод, помеченный `/twitter-mention` как в службе при возникновении события.

В `spec` элементе вы указываете `type` привязку, а также заданную привязку `metadata` . В примере указываются учетные данные для доступа к учетной записи Twitter с помощью API. Метаданные могут различаться между входными и выходными привязками. Например, чтобы использовать Twitter в качестве входной привязки, необходимо указать текст для поиска в твитах с помощью `query` поля. При каждом отправке соответствующего твита ДАПР расширения будет вызывать `/twitter-mention` конечную точку в службе. Он также будет доставлять содержимое твита.

Привязку можно настроить для ввода, вывода или и того и другого. Интересно, что привязка явно не задает входную или выходную конфигурацию. Вместо этого направление выводится при использовании привязки вместе со значениями конфигурации.

[ДАПР документация по привязкам ресурсов] [1] содержит полный список доступных привязок и их конкретные параметры конфигурации.

### <a name="cron-binding"></a>Привязка cron

Обратите особое внимание на привязку cron ДАПР. Он не подписывается на события из внешней системы. Вместо этого для запуска приложения в этой привязке используется настраиваемое расписание интервала. Привязка предоставляет простой способ реализации фоновой рабочей роли для пробуждения и выполнения некоторой работы с постоянным интервалом без необходимости реализации бесконечного цикла с настраиваемой задержкой. Ниже приведен пример конфигурации привязки cron:

```yaml
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: checkOrderBacklog
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
  - name: schedule
    value: "@every 30m"
```

В этом примере ДАПР активирует службу, вызывая `/checkOrderBacklog` конечную точку каждые 30 минут. Для указания значения можно использовать несколько шаблонов `schedule` . Дополнительные сведения см. в [документации по привязке cron](https://docs.dapr.io/operations/components/setup-bindings/supported-bindings/cron/).

## <a name="reference-application-eshopondapr"></a>Эталонное приложение: Ешопондапр

Сопутствующее эталонное приложение Ешопондапр реализует пример выходной привязки. Он запускает привязку ДАПР [SendGrid](https://docs.dapr.io/operations/components/setup-bindings/supported-bindings/sendgrid/) для отправки пользователю сообщения электронной почты при помещении нового заказа. Эту привязку можно найти в `eshop-email.yaml` файле в папке Components:

```yaml
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: sendmail
  namespace: eshop
spec:
  type: bindings.twilio.sendgrid
  version: v1
  metadata:
  - name: apiKey
    secretKeyRef:
      name: sendGridAPIKey
auth:
  secretStore: eshop-secretstore
```

В этой конфигурации используется компонент привязки [Twilio SendGrid](https://github.com/dapr/components-contrib/tree/master/bindings/twilio) . Обратите внимание, что ключ API для подключения к службе использует ссылку на секрет ДАПР. Этот подход обеспечивает хранение секретов за пределами файла конфигурации. Дополнительные сведения о секретах ДАПР см. в [разделе секреты стандартного блока](secrets.md) .

Конфигурация привязки указывает компонент привязки, который можно вызвать с помощью `/sendmail` конечной точки в ДАПР расширения. Ниже приведен фрагмент кода, в котором отправляется сообщение электронной почты при каждом запуске заказа:

```csharp
public Task Handle(OrderStartedDomainEvent notification, CancellationToken cancellationToken)
{
    var string message = CreateEmailBody(notification);
    var metadata = new Dictionary<string, string>
    {
        {"emailFrom", "eShopOn@dapr.io"},
        {"emailTo", notification.UserName},
        {"subject", $"Your eShopOnDapr order #{notification.Order.Id}"}
    };
    return _daprClient.InvokeBindingAsync("sendmail", "create", message, metadata, cancellationToken);
}
```

Как видно в этом примере, `message` содержит текст сообщения. `CreateEmailBody`Метод просто форматирует строку с текстом текста. `metadata`Указывает отправителя, получателя и тему сообщения электронной почты. Если эти значения являются статическими, они также могут быть включены в поля метаданных в файле конфигурации. Имя вызываемой привязки — `sendmail` , а операция — `create` .

## <a name="summary"></a>Итоги

Привязки ресурсов ДАПР позволяют интегрироваться с различными внешними ресурсами и системами без зависимости от их библиотек или пакетов SDK. Эти внешние системы не обязательно должны быть системами обмена сообщениями, такими как служебная шина или брокер сообщений. Также существуют привязки для хранилищ данных и веб-ресурсов, таких как Twitter или SendGrid.

Входные привязки (или триггеры) реагируют на события, происходящие во внешней системе. Они вызывают общедоступные конечные точки HTTP, предварительно настроенные в приложении. ДАПР использует имя привязки в конфигурации, чтобы определить конечную точку для вызова в приложении.

Выходные привязки будут отсылать сообщения во внешнюю систему. Вы активируете выходную привязку, выполняя HTTP-запрос POST к `/v1.0/bindings/<binding-name>` конечной точке на ДАПР расширения. Для вызова привязки можно также использовать gRPC. Пакет SDK для .NET предлагает `InvokeBindingAsync` метод для вызова привязок ДАПР с помощью gRPC.

Вы реализуете привязку с помощью компонента ДАПР. Эти компоненты предоставляются сообществом. Конфигурация каждого компонента привязки имеет метаданные, характерные для внешней системы, которая является абстрактной. Кроме того, поддерживаемые ею команды и структура полезных данных будут отличаться для каждого компонента привязки.

### <a name="references"></a>Ссылки

- [Документация по ДАПР для привязок ресурсов](https://docs.dapr.io/operations/components/setup-bindings/supported-bindings/)

>[!div class="step-by-step"]
>[Назад](publish-subscribe.md)
>[Вперед](observability.md)
