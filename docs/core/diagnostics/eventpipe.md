---
title: Общие сведения об EventPipe
description: Узнайте об EventPipe и о том, как использовать его для трассировки приложений .NET для диагностики проблем с производительностью.
ms.date: 11/09/2020
ms.topic: overview
ms.openlocfilehash: 00378c4f409b307afa9183e40de6078cdafd3ae7
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94820622"
---
# <a name="eventpipe"></a><span data-ttu-id="5bf84-103">Каналы событий</span><span class="sxs-lookup"><span data-stu-id="5bf84-103">EventPipe</span></span>

<span data-ttu-id="5bf84-104">EventPipe — это компонент среды выполнения, который можно использовать для получения данных трассировки, аналогично ETW или LTTng.</span><span class="sxs-lookup"><span data-stu-id="5bf84-104">EventPipe is a runtime component that can be used to collect tracing data, similar to ETW or LTTng.</span></span> <span data-ttu-id="5bf84-105">Цель использования EventPipe заключается в том, чтобы позволить разработчикам .NET с легкостью отслеживать свои приложения .NET, не прибегая к собственным компонентам операционной системы, таким как ETW или LTTng.</span><span class="sxs-lookup"><span data-stu-id="5bf84-105">The goal of EventPipe is to allow .NET developers to easily trace their .NET applications without having to rely on platform-specific OS-native components such as ETW or LTTng.</span></span>

<span data-ttu-id="5bf84-106">EventPipe — это механизм для многих средств диагностики, который можно использовать для потребления событий, генерируемых средой выполнения, а также настраиваемых событий, написанных с помощью [EventSource](xref:System.Diagnostics.Tracing.EventSource).</span><span class="sxs-lookup"><span data-stu-id="5bf84-106">EventPipe is the mechanism behind many of the diagnostic tools and can be used for consuming events emitted by the runtime as well as custom events written with [EventSource](xref:System.Diagnostics.Tracing.EventSource).</span></span>

<span data-ttu-id="5bf84-107">В этой статье представлены общие сведения об EventPipe, касающиеся того, когда и как использовать EventPipe, и как настроить его в соответствии с вашими потребностями.</span><span class="sxs-lookup"><span data-stu-id="5bf84-107">This article is a high-level overview of EventPipe describing when and how to use EventPipe, and how to configure it to best suit your needs.</span></span>

## <a name="eventpipe-basics"></a><span data-ttu-id="5bf84-108">Основы EventPipe</span><span class="sxs-lookup"><span data-stu-id="5bf84-108">EventPipe basics</span></span>

<span data-ttu-id="5bf84-109">EventPipe объединяет события, созданные компонентами среды выполнения, например JIT-компилятором или сборщиком мусора, а также события, записанные из экземпляров [EventSource](xref:System.Diagnostics.Tracing.EventSource) в библиотеках и пользовательском коде.</span><span class="sxs-lookup"><span data-stu-id="5bf84-109">EventPipe aggregates events emitted by runtime components - for example, the Just-In-Time compiler or the garbage collector - and events written from [EventSource](xref:System.Diagnostics.Tracing.EventSource) instances in the libraries and user code.</span></span>

<span data-ttu-id="5bf84-110">Затем события сериализуются и могут быть записаны непосредственно в файл или использованы через порт диагностики вне процесса.</span><span class="sxs-lookup"><span data-stu-id="5bf84-110">The events are then serialized and can be written directly to a file or consumed through a Diagnostics Port from out-of-proces.</span></span> <span data-ttu-id="5bf84-111">В Windows порты диагностики реализуются как `NamedPipe`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-111">On Windows, Diagnostic Ports are implemented as `NamedPipe`s.</span></span> <span data-ttu-id="5bf84-112">На платформах, отличных от Windows, таких как Linux или macOS, это реализуется с помощью сокетов доменов UNIX.</span><span class="sxs-lookup"><span data-stu-id="5bf84-112">On non-Windows platforms, such as Linux or macOS, it is implemented using Unix Domain Sockets.</span></span> <span data-ttu-id="5bf84-113">Дополнительные сведения о порте диагностики и о том, как взаимодействовать с ним через свой настраиваемый протокол межпроцессного взаимодействия, см. в [документации по протоколу диагностики IPC](https://github.com/dotnet/diagnostics/blob/master/documentation/design-docs/ipc-protocol.md).</span><span class="sxs-lookup"><span data-stu-id="5bf84-113">For more information about the Diagnostics Port and how to interact with it via its custom inter-process communication protocol, see the [diagnostics IPC protocol documentation](https://github.com/dotnet/diagnostics/blob/master/documentation/design-docs/ipc-protocol.md).</span></span>

<span data-ttu-id="5bf84-114">Затем EventPipe записывает сериализованные события в файл `.nettrace` в виде потока через диагностические порты или непосредственно в файл.</span><span class="sxs-lookup"><span data-stu-id="5bf84-114">EventPipe then writes the serialized events in the `.nettrace` file format, either as a stream via Diagnostic Ports or directly to a file.</span></span> <span data-ttu-id="5bf84-115">Дополнительные сведения о формате сериализации EventPipe см. в [документации по формату EventPipe](https://github.com/microsoft/perfview/blob/master/src/TraceEvent/EventPipe/EventPipeFormat.md).</span><span class="sxs-lookup"><span data-stu-id="5bf84-115">To learn more about the EventPipe serialization format, refer to the [EventPipe format documentation](https://github.com/microsoft/perfview/blob/master/src/TraceEvent/EventPipe/EventPipeFormat.md).</span></span>

## <a name="eventpipe-vs-etwlttng"></a><span data-ttu-id="5bf84-116">EventPipe и ETW/LTTng</span><span class="sxs-lookup"><span data-stu-id="5bf84-116">EventPipe vs. ETW/LTTng</span></span>

<span data-ttu-id="5bf84-117">EventPipe является частью среды выполнения .NET (CoreCLR) и разработан так же, как и на всех платформах, поддерживаемых .NET Core.</span><span class="sxs-lookup"><span data-stu-id="5bf84-117">EventPipe is part of the .NET runtime (CoreCLR) and is designed to work the same way across all the platforms .NET Core supports.</span></span> <span data-ttu-id="5bf84-118">Это позволяет средствам трассировки, основанным на EventPipe, например `dotnet-counters`, `dotnet-gcdump` и `dotnet-trace`, беспрепятственно работать на разных платформах.</span><span class="sxs-lookup"><span data-stu-id="5bf84-118">This allows tracing tools based on EventPipe, such as `dotnet-counters`, `dotnet-gcdump`, and `dotnet-trace`, to work seamlessly across platforms.</span></span>

<span data-ttu-id="5bf84-119">Однако, поскольку EventPipe является встроенным компонентом среды выполнения, его область ограничена управляемым кодом и самой средой выполнения.</span><span class="sxs-lookup"><span data-stu-id="5bf84-119">However, because EventPipe is a runtime built-in component, its scope is limited to managed code and the runtime itself.</span></span> <span data-ttu-id="5bf84-120">EventPipe нельзя использовать для отслеживания некоторых событий низкого уровня, таких как разрешение стека машинного кода или получение различных событий ядра.</span><span class="sxs-lookup"><span data-stu-id="5bf84-120">EventPipe cannot be used for tracking some lower-level events, such as resolving native code stack or getting various kernel events.</span></span> <span data-ttu-id="5bf84-121">Если вы используете в своем приложении межпроцессное взаимодействие C/C++ или требуется отследить саму среду выполнения (написанную на C++), а может, хотите глубже отслеживать поведение приложения, которое требует событий ядра (то есть событий переключения контекста в собственном потоке), следует использовать ETW или [perf/LTTng](./trace-perfcollect-lttng.md).</span><span class="sxs-lookup"><span data-stu-id="5bf84-121">If you use C/C++ interop in your app or you want to trace the runtime itself (which is written in C++), or want deeper diagnostics into the behavior of the app that requires kernel events (that is, native-thread context-switching events) you should use ETW or [perf/LTTng](./trace-perfcollect-lttng.md).</span></span>

<span data-ttu-id="5bf84-122">Еще одно важное различие между EventPipe и ETW/LTTng — обязательное наличие прав администратора или прав корневого уровня.</span><span class="sxs-lookup"><span data-stu-id="5bf84-122">Another major difference between EventPipe and ETW/LTTng is admin/root privilege requirement.</span></span> <span data-ttu-id="5bf84-123">Чтобы выполнить трассировку приложения с помощью ETW или LTTng, необходимо быть администратором или обладать правами корневого уровня.</span><span class="sxs-lookup"><span data-stu-id="5bf84-123">To trace an application using ETW or LTTng you need to be an admin/root.</span></span> <span data-ttu-id="5bf84-124">С помощью EventPipe можно выполнять трассировку приложений, если трассировка (например, `dotnet-trace`) выполняется от имени пользователя, запустившего приложение.</span><span class="sxs-lookup"><span data-stu-id="5bf84-124">Using EventPipe, you can trace applications as long as the tracer (for example, `dotnet-trace`) is run as the same user as the user that launched the application.</span></span>

<span data-ttu-id="5bf84-125">В следующей таблице приведена сводка различий между EventPipe и ETW/LTTng.</span><span class="sxs-lookup"><span data-stu-id="5bf84-125">The following table is a summary of the differences between EventPipe and ETW/LTTng.</span></span>

|<span data-ttu-id="5bf84-126">Функция</span><span class="sxs-lookup"><span data-stu-id="5bf84-126">Feature</span></span>|<span data-ttu-id="5bf84-127">Каналы событий</span><span class="sxs-lookup"><span data-stu-id="5bf84-127">EventPipe</span></span>|<span data-ttu-id="5bf84-128">Трассировка событий Windows</span><span class="sxs-lookup"><span data-stu-id="5bf84-128">ETW</span></span>|<span data-ttu-id="5bf84-129">LTTng</span><span class="sxs-lookup"><span data-stu-id="5bf84-129">LTTng</span></span>|
|-------|---------|---|-----------|
|<span data-ttu-id="5bf84-130">Поддержка разных платформ</span><span class="sxs-lookup"><span data-stu-id="5bf84-130">Cross-platform</span></span>|<span data-ttu-id="5bf84-131">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-131">Yes</span></span>|<span data-ttu-id="5bf84-132">Нет (только в Windows)</span><span class="sxs-lookup"><span data-stu-id="5bf84-132">No (only on Windows)</span></span>|<span data-ttu-id="5bf84-133">Нет (только в поддерживаемых дистрибутивах Linux)</span><span class="sxs-lookup"><span data-stu-id="5bf84-133">No (only on supported Linux distros)</span></span>|
|<span data-ttu-id="5bf84-134">Требуются права администратора или корневого пользователя</span><span class="sxs-lookup"><span data-stu-id="5bf84-134">Require admin/root privilege</span></span>|<span data-ttu-id="5bf84-135">Нет</span><span class="sxs-lookup"><span data-stu-id="5bf84-135">No</span></span>|<span data-ttu-id="5bf84-136">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-136">Yes</span></span>|<span data-ttu-id="5bf84-137">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-137">Yes</span></span>|
|<span data-ttu-id="5bf84-138">Может получить события операционной системы или ядра</span><span class="sxs-lookup"><span data-stu-id="5bf84-138">Can get OS/kernel events</span></span>|<span data-ttu-id="5bf84-139">Нет</span><span class="sxs-lookup"><span data-stu-id="5bf84-139">No</span></span>|<span data-ttu-id="5bf84-140">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-140">Yes</span></span>|<span data-ttu-id="5bf84-141">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-141">Yes</span></span>|
|<span data-ttu-id="5bf84-142">Может разрешить собственные стеки вызовов</span><span class="sxs-lookup"><span data-stu-id="5bf84-142">Can resolve native callstacks</span></span>|<span data-ttu-id="5bf84-143">Нет</span><span class="sxs-lookup"><span data-stu-id="5bf84-143">No</span></span>|<span data-ttu-id="5bf84-144">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-144">Yes</span></span>|<span data-ttu-id="5bf84-145">Да</span><span class="sxs-lookup"><span data-stu-id="5bf84-145">Yes</span></span>|

## <a name="use-eventpipe-to-trace-your-net-application"></a><span data-ttu-id="5bf84-146">Использование EventPipe для трассировки приложения .NET</span><span class="sxs-lookup"><span data-stu-id="5bf84-146">Use EventPipe to trace your .NET application</span></span>

<span data-ttu-id="5bf84-147">EventPipe можно использовать для трассировки приложения .NET различными способами:</span><span class="sxs-lookup"><span data-stu-id="5bf84-147">You can use EventPipe to trace your .NET application in many ways:</span></span>

* <span data-ttu-id="5bf84-148">Используйте одно из [средств диагностики](#tools-that-use-eventpipe), созданных на основе EventPipe.</span><span class="sxs-lookup"><span data-stu-id="5bf84-148">Use one of the [diagnostics tools](#tools-that-use-eventpipe) that are built on top of EventPipe.</span></span>

* <span data-ttu-id="5bf84-149">Используйте библиотеку [Microsoft.Diagnostics.NETCore.Client](https://github.com/dotnet/diagnostics/blob/master/documentation/diagnostics-client-library-instructions.md), чтобы написать собственное средство для самостоятельной настройки и запуска сеансов EventPipe.</span><span class="sxs-lookup"><span data-stu-id="5bf84-149">Use [Microsoft.Diagnostics.NETCore.Client](https://github.com/dotnet/diagnostics/blob/master/documentation/diagnostics-client-library-instructions.md) library to write your own tool to configure and start EventPipe sessions yourself.</span></span>

* <span data-ttu-id="5bf84-150">Для запуска EventPipe используйте [переменные среды](#trace-using-environment-variables).</span><span class="sxs-lookup"><span data-stu-id="5bf84-150">Use [environment variables](#trace-using-environment-variables) to start EventPipe.</span></span>

<span data-ttu-id="5bf84-151">После создания файла `nettrace`, содержащего события EventPipe, можно просмотреть файл в [`PerfView`](https://github.com/Microsoft/perfview#perfview-overview) или Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="5bf84-151">After you've produced a `nettrace` file that contains your EventPipe events, you can view the file in [`PerfView`](https://github.com/Microsoft/perfview#perfview-overview) or Visual Studio.</span></span> <span data-ttu-id="5bf84-152">На платформах, отличных от Windows, можно преобразовать файл `nettrace` в формат трассировки `speedscope` или `Chromium` с помощью команды [`dotnet-trace convert`](./dotnet-trace.md#dotnet-trace-convert) и просмотреть ее с помощью [`speedscope`](https://www.speedscope.app/) или Chrome DevTools.</span><span class="sxs-lookup"><span data-stu-id="5bf84-152">On non-Windows platforms, you can convert the `nettrace` file to a `speedscope` or `Chromium` trace format by using [`dotnet-trace convert`](./dotnet-trace.md#dotnet-trace-convert) command and view it with [`speedscope`](https://www.speedscope.app/) or Chrome DevTools.</span></span>

<span data-ttu-id="5bf84-153">Трассировки EventPipe можно также анализировать программно с помощью [TraceEvent](https://github.com/Microsoft/perfview/blob/master/documentation/TraceEvent/TraceEventLibrary.md).</span><span class="sxs-lookup"><span data-stu-id="5bf84-153">You can also analyze EventPipe traces programmatically with [TraceEvent](https://github.com/Microsoft/perfview/blob/master/documentation/TraceEvent/TraceEventLibrary.md).</span></span>

### <a name="tools-that-use-eventpipe"></a><span data-ttu-id="5bf84-154">Средства, использующие EventPipe</span><span class="sxs-lookup"><span data-stu-id="5bf84-154">Tools that use EventPipe</span></span>

<span data-ttu-id="5bf84-155">Это самый простой способ использовать EventPipe для трассировки приложения.</span><span class="sxs-lookup"><span data-stu-id="5bf84-155">This is the easiest way to use EventPipe to trace your application.</span></span> <span data-ttu-id="5bf84-156">Дополнительные сведения об использовании каждого из этих средств см. в документации к каждому средству.</span><span class="sxs-lookup"><span data-stu-id="5bf84-156">To learn more about how to use each of these tools, refer to each tool's documentation.</span></span>

* <span data-ttu-id="5bf84-157">[dotnet-counters](./dotnet-counters.md) позволяет отслеживать и получать различные метрики, созданные средой выполнения .NET и основными библиотеками, а также пользовательские метрики, которые можно писать.</span><span class="sxs-lookup"><span data-stu-id="5bf84-157">[dotnet-counters](./dotnet-counters.md) lets you monitor and collect various metrics emitted by the .NET runtime and core libraries, as well as custom metrics you can write.</span></span>

* <span data-ttu-id="5bf84-158">[dotnet-gcdump](./dotnet-gcdump.md) позволяет выполнять сбор дампов кучи сборщика мусора для активных процессов для анализа управляемой кучи приложения.</span><span class="sxs-lookup"><span data-stu-id="5bf84-158">[dotnet-gcdump](./dotnet-gcdump.md) lets you collect GC heap dumps of live processes for analyzing an application's managed heap.</span></span>

* <span data-ttu-id="5bf84-159">[dotnet-trace](./dotnet-trace.md) позволяет собирать данные анализа производительности приложений.</span><span class="sxs-lookup"><span data-stu-id="5bf84-159">[dotnet-trace](./dotnet-trace.md) lets you collect traces of applications to analyze for performance.</span></span>

## <a name="trace-using-environment-variables"></a><span data-ttu-id="5bf84-160">Трассировка с помощью переменных среды</span><span class="sxs-lookup"><span data-stu-id="5bf84-160">Trace using environment variables</span></span>

<span data-ttu-id="5bf84-161">Предпочтительным механизмом для использования EventPipe является использование `dotnet-trace` или библиотеки `Microsoft.Diagnostics.NETCore.Client`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-161">The preferred mechanism for using EventPipe is to use `dotnet-trace` or the `Microsoft.Diagnostics.NETCore.Client` library.</span></span>

<span data-ttu-id="5bf84-162">Однако можно использовать следующие переменные среды для настройки сеанса EventPipe в приложении и записи трассировки непосредственно в файл.</span><span class="sxs-lookup"><span data-stu-id="5bf84-162">However, you can use the following environment variables to set up an EventPipe session on an app and have it write the trace directly to a file.</span></span> <span data-ttu-id="5bf84-163">Чтобы прекратить трассировку, закройте приложение.</span><span class="sxs-lookup"><span data-stu-id="5bf84-163">To stop tracing, exit the application.</span></span>

* <span data-ttu-id="5bf84-164">`COMPlus_EnableEventPipe`: Задайте значение `1`, чтобы запустить сеанс EventPipe, который выполняет запись непосредственно в файл.</span><span class="sxs-lookup"><span data-stu-id="5bf84-164">`COMPlus_EnableEventPipe`: Set this to `1` to start an EventPipe session that writes directly to a file.</span></span> <span data-ttu-id="5bf84-165">Значение по умолчанию — `0`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-165">The default value is `0`.</span></span>

* <span data-ttu-id="5bf84-166">`COMPlus_EventPipeOutputPath`: Путь к выходному файлу трассировки EventPipe, когда он настроен для выполнения через `COMPlus_EnableEventPipe`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-166">`COMPlus_EventPipeOutputPath`: The path to the output EventPipe trace file when it's configured to run via `COMPlus_EnableEventPipe`.</span></span> <span data-ttu-id="5bf84-167">Значение по умолчанию — `trace.nettrace`, которое будет создано в том же каталоге, из которого выполняется приложение.</span><span class="sxs-lookup"><span data-stu-id="5bf84-167">The default value is `trace.nettrace`, which will be created in the same directory that the app is running from.</span></span>

* <span data-ttu-id="5bf84-168">`COMPlus_CircularBufferMB`: Размер внутреннего буфера, используемого EventPipe, когда он настроен для выполнения через `COMPlus_EnableEventPipe`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-168">`COMPlus_CircularBufferMB`: The size of the internal buffer that is used by EventPipe when it's configured to run via `COMPlus_EnableEventPipe`.</span></span>

* <span data-ttu-id="5bf84-169">`COMPlus_EventPipeConfig`: Настраивает конфигурацию сеанса EventPipe при запуске сеанса EventPipe с `COMPlus_EnableEventPipe`.</span><span class="sxs-lookup"><span data-stu-id="5bf84-169">`COMPlus_EventPipeConfig`: Sets up the EventPipe session configuration when starting an EventPipe session with `COMPlus_EnableEventPipe`.</span></span>

  <span data-ttu-id="5bf84-170">Синтаксис выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="5bf84-170">The syntax is as follows:</span></span>

  `<provider>:<keyword>:<level>`

  <span data-ttu-id="5bf84-171">Можно также указать несколько поставщиков, объединив их с помощью запятой:</span><span class="sxs-lookup"><span data-stu-id="5bf84-171">You can also specify multiple providers by concatenating them with a comma:</span></span>

  `<provider1>:<keyword1>:<level1>,<provider2>:<keyword2>:<level2>`

  <span data-ttu-id="5bf84-172">Если эта переменная среды не задана, но EventPipe включен с помощью `COMPlus_EnableEventPipe`, компонент начнет трассировку, включив следующие поставщики со следующими ключевыми словами и уровнями:</span><span class="sxs-lookup"><span data-stu-id="5bf84-172">If this environment variable is not set but EventPipe is enabled by `COMPlus_EnableEventPipe`, it will start tracing by enabling the following providers with the following keywords and levels:</span></span>

  - `Microsoft-Windows-DotNETRuntime:4c14fccbd:5`
  - `Microsoft-Windows-DotNETRuntimePrivate:4002000b:5`
  - `Microsoft-DotNETCore-SampleProfiler:0:5`
