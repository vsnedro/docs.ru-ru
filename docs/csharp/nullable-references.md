---
title: Ссылочные типы, допускающие значение null
description: В этой статье представлен обзор ссылочных типов, допускающих значение NULL, добавленных в C# 8.0. Вы узнаете, как эта функция обеспечивает безопасность от исключений, связанных со ссылочными типами, допускающими значение NULL, в новых и существующих проектах.
ms.technology: csharp-null-safety
ms.date: 04/21/2020
ms.openlocfilehash: cb9438db6364b6dc5d34f3a776d3ed7ec2e9978b
ms.sourcegitcommit: 30a686fd4377fe6472aa04e215c0de711bc1c322
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2020
ms.locfileid: "94440397"
---
# <a name="nullable-reference-types"></a>Ссылочные типы, допускающие значение null

C# 8.0 представляет **ссылочные типы, допускающие значение NULL** и **ссылочные типы, не допускающие значение NULL**, которые позволяют делать важные заявления о свойствах для переменных ссылочного типа:

- **Ссылка не должна иметь значение NULL**. Когда переменные не должны иметь значение NULL, компилятор принудительно применяет правила, которые гарантируют, что можно разыменовать эти переменные без предварительной проверки того, что они не имеют значение NULL:
  - Переменную необходимо инициализировать со значением, отличным от NULL.
  - Переменной не может быть присвоено значение `null`.
- **Ссылка может иметь значение NULL**. Когда переменные могут иметь значение NULL, компилятор применяет различные правила, чтобы убедиться, что вы правильно проверили наличие пустой ссылки:
  - Переменная может быть разыменована только в том случае, когда компилятор может гарантировать, что значение не равно NULL.
  - Эти переменные могут быть инициализированы со значением по умолчанию `null`, и им можно присвоить значение `null` в другом коде.

Эта новая функция предоставляет значительные преимущества по сравнению с обработкой ссылочных переменных в более ранних версиях C#, где назначение кода невозможно было определить по объявлению переменной. Компилятор не обеспечивает безопасность от исключений, связанных с пустой ссылкой, для ссылочных типов:

- **Ссылка может иметь значение NULL**. Компилятор не выдает предупреждения, если переменная ссылочного типа инициализируется со значением `null` либо позднее получает значение `null`. Компилятор выдает предупреждения при разыменовании этих переменных без проверки значений NULL.
- **Предполагается, что ссылка не имеет значение NULL**. Компилятор не выдает предупреждения, когда ссылочные типы разыменованы. Компилятор выдает предупреждения, если в качестве значения переменной задано выражение, которое может иметь значение NULL.

Эти предупреждения выдаются во время компиляции. Компилятор не добавляет никаких проверок значений NULL или других конструкций среды выполнения в контексте, допускающем значение NULL. Во время выполнения ссылка, допускающая значение NULL, и ссылка, не допускающая значения NULL, являются эквивалентными.

С появлением ссылочных типов, допускающих значение NULL, вы можете более четко объявить свое намерение. Значение `null` — это правильный способ представить, что переменная не ссылается на значение. Эта функция не предназначена для удаления всех значений `null` из кода. Вместо этого следует объявить свое намерение компилятору и другим разработчикам, которые читают ваш код. Если вы объявите свое намерение, компилятор сообщит, когда ваш код не соответствует этому намерению.

**Ссылочный тип, допускающий значение NULL** использует тот же синтаксис, что и [тип значения, допускающего значение NULL](language-reference/builtin-types/nullable-value-types.md): к типу переменной добавляется `?`. Например, следующее объявление переменной представляет строковую переменную, допускающую значение NULL, `name`:

```csharp
string? name;
```

Любая переменная, где `?` не добавляется к имени типа, является **ссылочным типом, не допускающим значение NULL**. Сюда входят все переменные ссылочных типов в существующем коде, если вы включили эту функцию.

Компилятор использует статический анализ, чтобы определить, что ссылка, допускающая значение NULL, имеет значение, отличное от NULL. Компилятор выдает предупреждение, если вы разыменовываете ссылку, допускающую значение NULL, когда она может иметь значение NULL. Это поведение можно переопределить с помощью [оператора `!`, допускающего значение NULL](language-reference/operators/null-forgiving.md), следующего после имени переменной. Например, если вы знаете, что переменная `name` не имеет значение NULL, а компилятор выдает предупреждение, напишите следующий код, чтобы переопределить анализ компилятора:

```csharp
name!.Length;
```

## <a name="nullability-of-types"></a>Допустимость значений NULL для типов

Любой ссылочный тип может иметь один из четырех уровней *допустимости значений NULL*, который описывает, когда создаются предупреждения:

- *Не допускает значения NULL*: значение NULL нельзя присвоить переменным этого типа. Переменные этого типа не нужно проверять на значение NULL перед разыменованием.
- *Допускает значение NULL*: значение NULL можно присвоить переменным этого типа. Разыменование переменных этого типа без предварительной проверки `null` вызывает предупреждение.
- *Игнорировать*: существовало до версии C# 8.0. Переменные этого типа можно разыменовать или назначить без предупреждения.
- *Неизвестно*: обычно относится к параметрам типа, где ограничения не сообщают компилятору, что тип должен *допускать* или *не допускать значение NULL*.

Допустимость значений NULL для типа в объявлении переменной управляется *контекстом допустимости значения NULL*, в котором объявлена переменная.

## <a name="nullable-contexts"></a>Контексты допустимости значения NULL

Контексты допустимости значения NULL детально контролируют, как компилятор интерпретирует переменные ссылочного типа. **Контекст с заметками о допустимости значения NULL** любой исходной строки включен или отключен. Представьте себе, что компилятор до версии C# 8.0 компилирует весь код в контексте, допускающем значения NULL: все ссылочные типы могут иметь значение NULL. **Контекст с предупреждениями о допустимости значения NULL** также может быть включен или отключен. Контекст с предупреждениями о допустимости значения NULL указывает предупреждения, созданные компилятором с помощью анализа потока.

Контекст с заметками о допустимости значения NULL и контекст с предупреждениями о допустимости значения NULL можно задать для проекта с помощью элемента `Nullable` в файле *CSPROJ*. Этот элемент настраивает, как компилятор интерпретирует допустимость значений NULL для типов и какие предупреждения создаются. Допустимые значения:

- `enable`. Контекст с заметками о допустимости значения NULL **включен**. Контекст с предупреждениями о допустимости значения NULL **включен**.
  - Переменные ссылочного типа, например `string`, не допускают значения NULL.  Все предупреждения о допустимости значений NULL включены.
- `warnings`. Контекст с заметками о допустимости значения NULL **отключен**. Контекст с предупреждениями о допустимости значения NULL **включен**.
  - Переменные ссылочного типа игнорируют допустимость. Все предупреждения о допустимости значений NULL включены.
- `annotations`. Контекст с заметками о допустимости значения NULL **включен**. Контекст с предупреждениями о допустимости значения NULL **отключен**.
  - Переменные ссылочного типа, например строка, не допускают значения NULL. Все предупреждения о допустимости значений NULL отключены.
- `disable`. Контекст с заметками о допустимости значения NULL **отключен**. Контекст с предупреждениями о допустимости значения NULL **отключен**.
  - Переменные ссылочного типа игнорируют допустимость, как и в более ранних версиях C#. Все предупреждения о допустимости значений NULL отключены.

**Пример**:

```xml
<Nullable>enable</Nullable>
```

Также можно использовать директивы для задания этих контекстов в любом месте в проекте:

- `#nullable enable`. Устанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в режим **включен**.
- `#nullable disable`. Устанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в режим **отключен**.
- `#nullable restore`. Восстанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в соответствии с параметрами проекта.
- `#nullable disable warnings`. Устанавливает контекст с предупреждениями о допустимости значения NULL в режим **отключен**.
- `#nullable enable warnings`. Устанавливает контекст с предупреждениями о допустимости значения NULL в режим **включен**.
- `#nullable restore warnings`. Восстанавливает контекст с предупреждениями о допустимости NULL в соответствии с параметрами проекта.
- `#nullable disable annotations`. Устанавливает контекст с заметками о допустимости значения NULL в режим **отключен**.
- `#nullable enable annotations`. Устанавливает контекст с заметками о допустимости значения NULL в режим **включен**.
- `#nullable restore annotations`. Восстанавливает контекст с предупреждениями о заметках в соответствии с параметрами проекта.

По умолчанию контексты с заметками и предупреждениями о допустимости значения NULL **отключены**, включая новые проекты. Это означает, что существующий код компилируется без изменений и без создания новых предупреждений.

Эти параметры предоставляют две отдельные стратегии для [обновления существующей базы кода](nullable-migration-strategies.md) так, чтобы она могла использовать ссылочные типы, допускающие значение NULL.

## <a name="nullable-annotation-context"></a>Контекст с заметками о допустимости значений NULL

Компилятор использует следующие правила в отключенном контексте с заметками о допустимости значения NULL:

- Нельзя объявлять ссылки, допускающие значение NULL, в отключенном контексте.
- Всем ссылочным переменным можно присвоить значение NULL.
- При разыменовании переменной ссылочного типа не выдаются предупреждения.
- Оператор, допускающий NULL, нельзя использовать в отключенном контексте.

Это поведение аналогично предыдущим версиям C#.

Компилятор использует следующие правила во включенном контексте с заметками о допустимости значения NULL:

- Любая переменная ссылочного типа является **ссылкой, не допускающей значение NULL**.
- Любая ссылка, не допускающая значение NULL, может быть безопасно разыменована.
- Любой ссылочный тип, допускающий значение NULL, (с `?` после типа в объявлении переменной) может иметь значение NULL. Статический анализ определяет, что значение не имеет значение NULL при разыменовывании. В противном случае компилятор выдает предупреждение.
- Оператор допустимости значения NULL можно использовать для объявления того, что ссылка, допускающая значение NULL, не имеет значение NULL.

Во включенном контексте с заметками о допустимости значения NULL символ `?`, добавленный к ссылочному типу, объявляет **ссылочный тип, допускающий значение NULL**. **Оператор `!`, допускающий значение NULL**, можно добавить в выражение, чтобы объявить, что выражение не имеет значение NULL.

## <a name="nullable-warning-context"></a>Контекст с предупреждениями о допустимости значений NULL

Контекст с заметками о допустимости значений NULL отличается от контекста с предупреждениями. Предупреждения можно включить даже в том случае, если заметки отключены. Компилятор использует статический анализ потока для определения **состояния значения NULL** любой ссылки. Состояние значения NULL может быть **не NULL** или **может быть NULL**, если *контекст с предупреждениями о допустимости значения NULL* не **отключен**. Если вы пытаетесь разыменовать ссылку, когда компилятор определяет, что она может **иметь значение NULL**, компилятор выдает предупреждение. Состояние ссылки — **может иметь значение NULL**, за тем исключением, если компилятор может определить одно из двух условий:

1. Переменной определенно присвоено значение, отличное от NULL.
1. Переменная или выражение проверены на значение NULL до разыменования.

Компилятор выдает предупреждения при каждом разыменовании переменной или выражения в состоянии **может иметь значение NULL** в допускающем значение NULL контексте с предупреждением. Кроме того, компилятор создает предупреждения, когда переменной ссылочного типа, не допускающей значение NULL, присваивается переменная или выражение, **допускающие значение NULL**, во включенном контексте с заметками, допускающем значение NULL.

## <a name="attributes-describe-apis"></a>Атрибуты для описания API

Атрибуты добавляются в API, которые предоставляют компилятору дополнительные сведения о том, когда аргументы или возвращаемые значения могут или не могут иметь значение NULL. Дополнительные сведения об этих атрибутах см. в статье справочника по языку, где рассматриваются [атрибуты, допускающие значение NUL](language-reference/attributes/nullable-analysis.md). Эти атрибуты добавляются в библиотеки .NET в текущих и будущих выпусках. Сначала обновляются наиболее часто используемые API.

## <a name="known-pitfalls"></a>Известные ошибки

С массивами и структурами, содержащими ссылочные типы, связаны известные ошибки при использовании функции ссылочных типов, допускающих значения NULL.

### <a name="structs"></a>Структуры

Структуре, которая содержит ссылочные типы, не допускающие значения NULL, может быть присвоено значение `default` без предупреждения. Рассмотрим следующий пример.

```csharp
using System;

#nullable enable

public struct Student
{
    public string FirstName;
    public string? MiddleName;
    public string LastName;
}

public static class Program
{
    public static void PrintStudent(Student student)
    {
        Console.WriteLine($"First name: {student.FirstName.ToUpper()}");
        Console.WriteLine($"Middle name: {student.MiddleName.ToUpper()}");
        Console.WriteLine($"Last name: {student.LastName.ToUpper()}");
    }

    public static void Main() => PrintStudent(default);
}
```

В предыдущем примере в `PrintStudent(default)` не возвращается предупреждение, хотя ссылочные типы `FirstName` и `LastName`, не допускающие значения NULL, имеют значение NULL.

Еще один более распространенный случай связан с работой с универсальными структурами. Рассмотрим следующий пример.

```csharp
#nullable enable

public struct Foo<T>
{
    public T Bar { get; set; }
}

public static class Program
{
    public static void Main()
    {
        string s = default(Foo<string>).Bar;
    }
}
```

В предыдущем примере свойство `Bar` во время выполнения будет иметь значение `null` и присваивается строке, не допускающей значения NULL. При этом предупреждения не возвращаются.

### <a name="arrays"></a>Массивы

При использовании ссылочных типов, допускающих значения NULL, также могут возникать известные ошибки, связанные с массивами. Рассмотрим следующий пример, в котором не выдаются предупреждения:

```csharp
using System;

#nullable enable

public static class Program
{
    public static void Main()
    {
        string[] values = new string[10];
        string s = values[0];
        Console.WriteLine(s.ToUpper());
    }
}
```

В предыдущем примере объявление массива показывает, что он содержит строки, не допускающие значения NULL, а все элементы инициализируются с использованием значения NULL. После этого переменной `s` присваивается значение NULL (первый элемент массива). Наконец, переменная `s` разыменовывается, в результате чего во время выполнения возникает исключение.

## <a name="see-also"></a>См. также

- [Ссылочные типы, допускающие значение NULL. Черновик спецификации](~/_csharplang/proposals/csharp-8.0/nullable-reference-types-specification.md)
- [Учебник "Введение в ссылки, допускающие значения NULL"](tutorials/nullable-reference-types.md)
- [Перенос существующей базы кода на ссылки, допускающие значение NULL](tutorials/upgrade-to-nullable-references.md)
- [-nullable (параметр компилятора C#)](language-reference/compiler-options/nullable-compiler-option.md)
