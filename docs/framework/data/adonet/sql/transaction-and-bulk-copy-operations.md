---
title: Транзакции и операции массового копирования
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: 27fafc0ef45b80eddd993229f52d119b40b4956f
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91155448"
---
# <a name="transaction-and-bulk-copy-operations"></a>Транзакции и операции массового копирования

Операции массового копирования могут выполняться как изолированные операции или как часть многошаговой транзакции. В последнем случае вы можете выполнить более одной операции массового копирования в одной транзакции, а также выполнять другие операции с базами данных (такие как вставка, обновление и удаление) с возможностью фиксации или отката всей транзакции.  
  
 По умолчанию операция массового копирования выполняется как изолированная. Операция массового копирования выполняется не как транзакция и без возможности отката. Если необходимо выполнить откат полного копирования или его части в случае возникновения ошибки, можно использовать <xref:System.Data.SqlClient.SqlBulkCopy> управляемую транзакцию, выполнить операцию с массовым копированием в существующей транзакции или прикрепить к **системе. Transactions** <xref:System.Transactions.Transaction> .  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a>Выполнение операции массового копирования без использования транзакции  

 Следующее консольное приложение показывает, что происходит, когда во время операции массового копирования без транзакции возникает ошибка.  
  
 В этом примере и таблица источника, и целевая таблица включают столбец `Identity`, именуемый **ProductID**. Сначала код подготавливает целевую таблицу, удаляя все строки и вставляя одну строку, у которой **ProductID** точно существует в исходной таблице. По умолчанию в целевой таблице для каждой добавляемой строки создается новое значение столбца `Identity`. В этом примере при открытии соединения задается параметр, заставляющий процесс массовой загрузки использовать значения `Identity` из исходной таблицы.  
  
 Операция массового копирования выполняется со свойством <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A>, равным 10. Когда операция встречает недопустимую строку, вызывается исключение. В первом примере операция массового копирования выполняется без транзакции. Фиксируются все пакеты, скопированные до появления ошибки. Пакет, содержащий повторяющийся ключ, откатывается, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!NOTE]
> Этот пример не будет выполняться, если вы не создали рабочие таблицы, как описано в статье [Пример установки с помощью инструкций копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a>Выполнение специальной операции массового копирования в транзакции  

 По умолчанию операция массового копирования является своей собственной транзакцией. Если вы хотите выполнить выделенную операцию массового копирования, создайте новый экземпляр <xref:System.Data.SqlClient.SqlBulkCopy> с помощью строки подключения или примените существующий объект <xref:System.Data.SqlClient.SqlConnection>, в котором нет активных транзакций. В каждом случае операция массового копирования создает и затем фиксирует или откатывает транзакцию.  
  
 Вы можете явно указать параметр <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> в <xref:System.Data.SqlClient.SqlBulkCopy>, чтобы в явном виде заставить операцию массового копирования выполняться в своей собственной транзакции, вследствие чего каждый пакет операции будет выполняться в отдельной транзакции.  
  
> [!NOTE]
> Поскольку разные пакеты выполняются в разных транзакциях, если во время операции массового копирования возникает ошибка, для всех строк в текущем пакете будет выполнен откат, но строки из предыдущих пакетов останутся в базе данных.  
  
 Следующее консольное приложение похоже на предыдущий пример с одним исключением: в этом примере операция массового копирования обрабатывает собственные транзакции. Фиксируются все пакеты, скопированные до появления ошибки. Пакет, содержащий повторяющийся ключ, откатывается, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!IMPORTANT]
> Этот пример не будет выполняться, если вы не создали рабочие таблицы, как описано в статье [Пример установки с помощью инструкций копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a>Использование существующих транзакций  

 Вы можете указать существующий объект <xref:System.Data.SqlClient.SqlTransaction> в качестве параметра в конструкторе <xref:System.Data.SqlClient.SqlBulkCopy>. В этом случае операция массового копирования выполняется в существующей транзакции, а состояние транзакции не изменяется (то есть она не фиксируется и не прерывается). Это позволяет приложению включить операцию массового копирования в транзакцию с другими операциями базы данных. Но если вы не укажете объект <xref:System.Data.SqlClient.SqlTransaction> и передадите пустую ссылку, а соединение содержит активную транзакцию, создается исключение.  
  
 Если вам нужно откатить всю операцию массового копирования из-за возникшей ошибки, или это массовое копирование является частью более масштабного отменяемого процесса, вы можете передать объект <xref:System.Data.SqlClient.SqlTransaction> в конструктор <xref:System.Data.SqlClient.SqlBulkCopy>.  
  
 Следующее консольное приложение похоже на первый пример (без транзакции) с одним исключением: в этом примере операция массового копирования включена в большую, внешнюю транзакцию. Если возникает ошибка нарушения первичного ключа, производится откат всей транзакции и никакие строки не добавляются в целевую таблицу.  
  
> [!IMPORTANT]
> Этот пример не будет выполняться, если вы не создали рабочие таблицы, как описано в статье [Пример установки с помощью инструкций копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a>См. также раздел

- [Операции массового копирования в SQL Server](bulk-copy-operations-in-sql-server.md)
- [Общие сведения об ADO.NET](../ado-net-overview.md)
