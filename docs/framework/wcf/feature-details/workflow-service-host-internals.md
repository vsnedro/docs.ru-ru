---
title: Внутренние особенности размещения службы рабочего процесса
ms.date: 03/30/2017
ms.assetid: af44596f-bf6a-4149-9f04-08d8e8f45250
ms.openlocfilehash: 23ee0533d5386164dc95cb7fe2c61a626ea3f96e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "96295747"
---
# <a name="workflow-service-host-internals"></a>Внутренние особенности размещения службы рабочего процесса

Объект <xref:System.ServiceModel.WorkflowServiceHost> предоставляет возможность размещения служб рабочего процесса. Он отвечает за прослушивание входящих сообщений и перенаправление их соответствующему экземпляру службы рабочего процесса, управляет выгрузкой и сохранением бездействующих рабочих процессов, а также выполняет другие функции. В этом разделе описано, как объект WorkflowServiceHost обрабатывает входящие сообщения.  
  
## <a name="workflowservicehost-overview"></a>Обзор WorkflowServiceHost  

Класс <xref:System.ServiceModel.WorkflowServiceHost> используется для размещения служб рабочего процесса. Он прослушивает входящие сообщения и перенаправляет их соответствующему экземпляру службы рабочих процессов, создавая при необходимости новые экземпляры или загружая существующие из долговременного хранилища. На следующей схеме показано на высоком уровне принцип <xref:System.ServiceModel.WorkflowServiceHost> работы:
  
 ![Схема, на которой показан обзор узла службы рабочих процессов.](./media/workflow-service-host-internals/workflow-service-host-high-level-overview.gif)  
  
 Из схемы видно, что объект <xref:System.ServiceModel.WorkflowServiceHost> загружает определения служб рабочих процессов из XAMLX-файлов, а сведения о конфигурации из файла конфигурации. Кроме того, он загружает конфигурацию отслеживания из профиля отслеживания. <xref:System.ServiceModel.WorkflowServiceHost> предоставляет конечную точку управления рабочим процессом, которая позволяет отправлять экземплярам рабочих процессов команды управления.  Дополнительные сведения см. в разделе [Пример конечной точки управления рабочим процессом](workflow-control-endpoint.md).  
  
 Объект <xref:System.ServiceModel.WorkflowServiceHost> предоставляет также конечные точки приложений, которые прослушивают входящие сообщения приложений. При поступлении входящего сообщения оно перенаправляется соответствующему экземпляру службы рабочих процессов (если он в данный момент загружен). При необходимости создается новый экземпляр рабочего процесса. Если имеется сохраненный экземпляр, он загружается из хранилища.  
  
## <a name="workflowservicehost-details"></a>Подробные сведения о классе WorkflowServiceHost  

 На следующей схеме показано <xref:System.ServiceModel.WorkflowServiceHost> , как обрабатывает сообщения более подробно:  
  
 ![Схема, на которой показан поток сообщений узла службы рабочего процесса.](./media/workflow-service-host-internals/workflow-service-host-message-flow.gif)  
  
 На схеме изображены три различные конечные точки: конечная точка приложения, конечная точка управления рабочим процессом и конечная точка размещения рабочего процесса. Конечная точка приложения получает сообщения, связанные с конкретным экземпляром рабочего процесса. Конечная точка управления рабочим процессом прослушивает команды управления. Конечная точка размещения рабочего процесса прослушивает сообщения, при поступлении которых объект <xref:System.ServiceModel.WorkflowServiceHost> загружает и выполняет рабочие процессы, не относящиеся к службе. Как показано на схеме, все сообщения обрабатываются средой выполнения WCF.  Регулирование экземпляра службы рабочих процессов осуществляется с помощью свойства <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentInstances%2A>. Это свойство ограничивает количество одновременно функционирующих экземпляров службы рабочих процессов. После превышения этого ограничения все дополнительные запросы на создание новых экземпляров службы рабочего процесса или на активацию постоянных экземпляров службы заносятся в очередь. Поставленные в очередь запросы обрабатываются в последовательном порядке без учета того, являются ли они запросами к новому экземпляру или к работающему, постоянному экземпляру. Загруженные сведения о политике узла определяют, что происходит с необработанными исключениями, а также задают порядок выгрузки и сохранения бездействующих служб Workflow Services. Дополнительные сведения об этих разделах см. [в разделе Практическое руководство. Настройка поведения необработанного исключения рабочего процесса с помощью WorkflowServiceHost](config-workflow-unhandled-exception-workflowservicehost.md) и [Практическое руководство. Настройка поведения при простое с помощью WorkflowServiceHost](how-to-configure-idle-behavior-with-workflowservicehost.md). Экземпляры рабочих процессов сохраняются в соответствии с политиками узла размещения и повторно загружаются при необходимости. Дополнительные сведения о сохранении рабочих процессов см. [в статье Настройка сохраняемости с помощью WorkflowServiceHost](how-to-configure-persistence-with-workflowservicehost.md), [Создание длительно выполняющейся службы рабочих процессов](creating-a-long-running-workflow-service.md)и [Сохранение рабочего процесса](../../windows-workflow-foundation/workflow-persistence.md).  
  
 На следующем рисунке показан поток при вызове метода WorkflowServiceHost. Open:  
  
 ![Схема, показывающая последовательность при вызове метода WorkflowServiceHost. Open.](./media/workflow-service-host-internals/workflow-service-host-open.gif)  
  
 Рабочий процесс загружается из XAML, и создается дерево действий. Объект <xref:System.ServiceModel.WorkflowServiceHost> проходит по дереву действий и создает описание службы. К узлу размещения применяются параметры конфигурации. По завершении этих действий узел начинает прослушивать входящие сообщения.  
  
 На следующем рисунке показано, что <xref:System.ServiceModel.WorkflowServiceHost> делает, когда получает сообщение, связанное с действием Receive, для которого CanCreateInstance имеет значение `true` :  
  
 ![Дерево принятия решений, используемое узлом ВФС при получении сообщения, а CanCreateInstance имеет значение true.](./media/workflow-service-host-internals/workflow-service-host-receive-message-cancreateinstance.gif)  
  
 Сообщение поступает и обрабатывается стеком каналов WCF. Производится проверка ограничений, и выполняются запросы корреляции. Если сообщение привязано к существующему экземпляру, производится его доставка. Если необходимо создать новый экземпляр, производится проверка свойства CanCreateInstance действия Receive. Если оно имеет значение true, создается новый экземпляр, которому и перенаправляется сообщение.  
  
 На следующем рисунке показано, что делает объект <xref:System.ServiceModel.WorkflowServiceHost> при получении сообщения, привязанного к действию Receive, если его свойство CanCreateInstance имеет значение false.  
  
 ![Дерево принятия решений, используемое узлом ВФС при получении сообщения, а CanCreateInstance — значение false.](./media/workflow-service-host-internals/workflow-service-host-receive-message.gif)  
  
 Сообщение поступает и обрабатывается стеком каналов WCF. Производится проверка ограничений, и выполняются запросы корреляции. Сообщение привязывается к существующему экземпляру (так как свойство CanCreateInstance имеет значение false), для чего экземпляр загружается из хранилища, возобновляется закладка и выполняется рабочий процесс.  
  
> [!WARNING]
> Открытие узла размещения служб рабочих процессов завершится с ошибкой, если SQL Server настроен для прослушивания только по протоколу NamedPipe.  
  
## <a name="see-also"></a>См. также

- [Службы рабочего процесса](workflow-services.md)
- [Размещение службы рабочего процесса](hosting-workflow-services.md)
- [Конечная точка элемента управления рабочего процесса](workflow-control-endpoint.md)
- [Практическое руководство. Как настроить поведение необработанного исключения рабочего процесса при помощи WorkflowServiceHost](config-workflow-unhandled-exception-workflowservicehost.md)
- [Создание службы долго выполняющегося рабочего процесса](creating-a-long-running-workflow-service.md)
- [Сохраняемость рабочего процесса](../../windows-workflow-foundation/workflow-persistence.md)
