---
title: Общие сведения о коллекции BlockingCollection
description: Сведения о BlockingCollection<T>, потокобезопасном классе коллекции в .NET. Этот класс обеспечивает такие возможности, как параллельное добавление и извлечение элементов из нескольких потоков.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- BlockingCollection, overview
ms.assetid: 987ea3d7-0ad5-4238-8b64-331ce4eb3f0b
ms.openlocfilehash: 0378d038d6081c7ad04fc233ac151ab2bb223fa5
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94818666"
---
# <a name="blockingcollection-overview"></a><span data-ttu-id="4b0a5-104">Общие сведения о коллекции BlockingCollection</span><span class="sxs-lookup"><span data-stu-id="4b0a5-104">BlockingCollection Overview</span></span>
<span data-ttu-id="4b0a5-105"><xref:System.Collections.Concurrent.BlockingCollection%601> — это потокобезопасный класс коллекции, обеспечивающий следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="4b0a5-105"><xref:System.Collections.Concurrent.BlockingCollection%601> is a thread-safe collection class that provides the following features:</span></span>  
  
- <span data-ttu-id="4b0a5-106">реализует шаблон "производитель-получатель";</span><span class="sxs-lookup"><span data-stu-id="4b0a5-106">An implementation of the Producer-Consumer pattern.</span></span>  
  
- <span data-ttu-id="4b0a5-107">поддерживает параллельное добавление и извлечение элементов из нескольких потоков;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-107">Concurrent adding and taking of items from multiple threads.</span></span>  
  
- <span data-ttu-id="4b0a5-108">допускает указание максимальной емкости;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-108">Optional maximum capacity.</span></span>  
  
- <span data-ttu-id="4b0a5-109">поддерживает операции вставки и удаления, блокирующиеся при опустошении или заполнении коллекции;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-109">Insertion and removal operations that block when collection is empty or full.</span></span>  
  
- <span data-ttu-id="4b0a5-110">поддерживает условные операции вставки и удалении, не блокирующиеся или блокирующиеся лишь на определенное время;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-110">Insertion and removal "try" operations that do not block or that block up to a specified period of time.</span></span>  
  
- <span data-ttu-id="4b0a5-111">инкапсулирует все типы коллекций, реализующие интерфейс <xref:System.Collections.Concurrent.IProducerConsumerCollection%601>;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-111">Encapsulates any collection type that implements <xref:System.Collections.Concurrent.IProducerConsumerCollection%601></span></span>  
  
- <span data-ttu-id="4b0a5-112">поддерживает отмену с помощью токенов отмены;</span><span class="sxs-lookup"><span data-stu-id="4b0a5-112">Cancellation with cancellation tokens.</span></span>  
  
- <span data-ttu-id="4b0a5-113">поддерживает два вида перечисления с помощью оператора `foreach` (`For Each` в Visual Basic):</span><span class="sxs-lookup"><span data-stu-id="4b0a5-113">Two kinds of enumeration with `foreach` (`For Each` in Visual Basic):</span></span>  
  
    1. <span data-ttu-id="4b0a5-114">перечисление "только для чтения";</span><span class="sxs-lookup"><span data-stu-id="4b0a5-114">Read-only enumeration.</span></span>  
  
    2. <span data-ttu-id="4b0a5-115">перечисление, при котором элементы по мере перечисления удаляются.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-115">Enumeration that removes items as they are enumerated.</span></span>  
  
## <a name="bounding-and-blocking-support"></a><span data-ttu-id="4b0a5-116">Поддержка границ и блокировки</span><span class="sxs-lookup"><span data-stu-id="4b0a5-116">Bounding and Blocking Support</span></span>  
 <span data-ttu-id="4b0a5-117"><xref:System.Collections.Concurrent.BlockingCollection%601> поддерживает границы и блокировку.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-117"><xref:System.Collections.Concurrent.BlockingCollection%601> supports bounding and blocking.</span></span> <span data-ttu-id="4b0a5-118">Поддержка границ означает возможность задать максимальную емкость коллекции.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-118">Bounding means you can set the maximum capacity of the collection.</span></span> <span data-ttu-id="4b0a5-119">Границы важны в ряде сценариев, поскольку они позволяют контролировать максимальный размер коллекции в памяти, предотвращая ситуации, в которых потоки-создатели слишком сильно обгоняют потоки-потребители.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-119">Bounding is important in certain scenarios because it enables you to control the maximum size of the collection in memory, and it prevents the producing threads from moving too far ahead of the consuming threads.</span></span>  
  
 <span data-ttu-id="4b0a5-120">Элементы коллекции могут параллельно добавляться из нескольких задач или потоков. Если коллекция достигает максимальной емкости, то потоки-создатели перейдут в состояние блокировки, пока не будет удален хотя бы один элемент.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-120">Multiple threads or tasks can add items to the collection concurrently, and if the collection reaches its specified maximum capacity, the producing threads will block until an item is removed.</span></span> <span data-ttu-id="4b0a5-121">Элементы коллекции могут параллельно удаляться несколькими потребителями. Если коллекция становится пустой, то потоки-потребители перейдут в состояние блокировки, пока поток-создатель не добавит хотя бы один элемент.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-121">Multiple consumers can remove items concurrently, and if the collection becomes empty, the consuming threads will block until a producer adds an item.</span></span> <span data-ttu-id="4b0a5-122">Поток-создатель может вызвать метод <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A>, чтобы указать, что он больше не будет добавлять элементы.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-122">A producing thread can call <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A> to indicate that no more items will be added.</span></span> <span data-ttu-id="4b0a5-123">Потребители могут отслеживать свойство <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A>, позволяющее определить, что коллекция опустела, а новые элементы добавляться не будут.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-123">Consumers monitor the <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> property to know when the collection is empty and no more items will be added.</span></span> <span data-ttu-id="4b0a5-124">В следующем примере демонстрируется простая коллекция BlockingCollection с максимальной емкостью в 100 элементов.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-124">The following example shows a simple BlockingCollection with a bounded capacity of 100.</span></span> <span data-ttu-id="4b0a5-125">Задача-создатель добавляет элементы в коллекцию на протяжении всего времени сохранения истинности некоторого внешнего условия, а после этого вызывает метод <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A>.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-125">A producer task adds items to the collection as long as some external condition is true, and then calls <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A>.</span></span> <span data-ttu-id="4b0a5-126">Задача-потребитель извлекает элементы, пока свойство <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> не примет логическое значение "true".</span><span class="sxs-lookup"><span data-stu-id="4b0a5-126">The consumer task takes items until the <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> property is true.</span></span>  
  
 [!code-csharp[CDS_BlockingCollection#04](../../../../samples/snippets/csharp/VS_Snippets_Misc/cds_blockingcollection/cs/blockingcollection.cs#04)]
 [!code-vb[CDS_BlockingCollection#04](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/cds_blockingcollection/vb/introsnippetsbc.vb#04)]  
  
 <span data-ttu-id="4b0a5-127">Полный пример см. в подразделе [Практическое руководство. Добавление и удаление отдельных элементов коллекции BlockingCollection](how-to-add-and-take-items.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-127">For a complete example, see [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="timed-blocking-operations"></a><span data-ttu-id="4b0a5-128">Операции с временной блокировкой</span><span class="sxs-lookup"><span data-stu-id="4b0a5-128">Timed Blocking Operations</span></span>  
 <span data-ttu-id="4b0a5-129">При использовании операций <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> и <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> ограниченных коллекций, использующих временную блокировку, метод предпринимает попытку добавления или удаления элемента.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-129">In timed blocking <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> and <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> operations on bounded collections, the method tries to add or take an item.</span></span> <span data-ttu-id="4b0a5-130">Если элемент доступен, то он заносится в указанную по ссылке переменную, после чего метод возвращает значение true.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-130">If an item is available it is placed into the variable that was passed in by reference, and the method returns true.</span></span> <span data-ttu-id="4b0a5-131">Если по прошествии определенного времени ожидания элемент так и не удается извлечь, метод возвращает значение false.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-131">If no item is retrieved after a specified time-out period the method returns false.</span></span> <span data-ttu-id="4b0a5-132">После этого поток может перейти к другой полезной работе, прежде чем повторить попытку обращения к коллекции.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-132">The thread is then free to do some other useful work before trying again to access the collection.</span></span> <span data-ttu-id="4b0a5-133">Пример доступа с временной блокировкой см. во втором примере из раздела [Практическое руководство. Добавление и удаление отдельных элементов коллекции BlockingCollection](how-to-add-and-take-items.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-133">For an example of timed blocking access, see the second example in [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="cancelling-add-and-take-operations"></a><span data-ttu-id="4b0a5-134">Отмена операций Add и Take</span><span class="sxs-lookup"><span data-stu-id="4b0a5-134">Cancelling Add and Take Operations</span></span>  
 <span data-ttu-id="4b0a5-135">Операции Add и Take обычно выполняются в цикле.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-135">Add and Take operations are typically performed in a loop.</span></span> <span data-ttu-id="4b0a5-136">Отменить цикл можно, передав в метод <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> или <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> токен <xref:System.Threading.CancellationToken> и проверяя значение его свойства <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> на каждой итерации.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-136">You can cancel a loop by passing in a <xref:System.Threading.CancellationToken> to the <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> or <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> method, and then checking the value of the token's <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property on each iteration.</span></span> <span data-ttu-id="4b0a5-137">Если значение равно true, за обработку запроса отмены отвечает разработчик, которому следует освободить ресурсы и завершить цикл.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-137">If the value is true, then it is up to you to respond the cancellation request by cleaning up any resources and exiting the loop.</span></span> <span data-ttu-id="4b0a5-138">В следующем примере показана перегрузка метода <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A>, которая принимает токен отмены, а также код, использующий эту перегрузку:</span><span class="sxs-lookup"><span data-stu-id="4b0a5-138">The following example shows an overload of <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> that takes a cancellation token, and the code that uses it:</span></span>  
  
 [!code-csharp[CDS_BlockingCollection#05](../../../../samples/snippets/csharp/VS_Snippets_Misc/cds_blockingcollection/cs/blockingcollection.cs#05)]
 [!code-vb[CDS_BlockingCollection#05](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/cds_blockingcollection/vb/introsnippetsbc.vb#05)]  
  
 <span data-ttu-id="4b0a5-139">Пример добавления поддержки отмены см. во втором примере из раздела [Практическое руководство. Добавление и удаление отдельных элементов коллекции BlockingCollection](how-to-add-and-take-items.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-139">For an example of how to add cancellation support, see the second example in [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="specifying-the-collection-type"></a><span data-ttu-id="4b0a5-140">Указание типа коллекции</span><span class="sxs-lookup"><span data-stu-id="4b0a5-140">Specifying the Collection Type</span></span>  
 <span data-ttu-id="4b0a5-141">При создании класса <xref:System.Collections.Concurrent.BlockingCollection%601> можно указать не только ограничиваемую емкость, но и тип используемой коллекции.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-141">When you create a <xref:System.Collections.Concurrent.BlockingCollection%601>, you can specify not only the bounded capacity but also the type of collection to use.</span></span> <span data-ttu-id="4b0a5-142">Например, можно задать объект <xref:System.Collections.Concurrent.ConcurrentQueue%601> для использования принципа "первым поступил — первым обслужен" или объект <xref:System.Collections.Concurrent.ConcurrentStack%601> для использования принципа "последним поступил — первым обслужен".</span><span class="sxs-lookup"><span data-stu-id="4b0a5-142">For example, you could specify a <xref:System.Collections.Concurrent.ConcurrentQueue%601> for first in-first out (FIFO) behavior, or a <xref:System.Collections.Concurrent.ConcurrentStack%601> for last in-first out (LIFO) behavior.</span></span> <span data-ttu-id="4b0a5-143">Использовать можно любой класс коллекции, реализующий интерфейс <xref:System.Collections.Concurrent.IProducerConsumerCollection%601>.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-143">You can use any collection class that implements the <xref:System.Collections.Concurrent.IProducerConsumerCollection%601> interface.</span></span> <span data-ttu-id="4b0a5-144">Тип коллекции, используемый в классе <xref:System.Collections.Concurrent.BlockingCollection%601> по умолчанию — это <xref:System.Collections.Concurrent.ConcurrentQueue%601>.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-144">The default collection type for <xref:System.Collections.Concurrent.BlockingCollection%601> is <xref:System.Collections.Concurrent.ConcurrentQueue%601>.</span></span> <span data-ttu-id="4b0a5-145">В следующем примере кода показано, как создать строковую коллекцию <xref:System.Collections.Concurrent.BlockingCollection%601> емкостью в 1000 элементов, которая использует класс <xref:System.Collections.Concurrent.ConcurrentBag%601>:</span><span class="sxs-lookup"><span data-stu-id="4b0a5-145">The following code example shows how to create a <xref:System.Collections.Concurrent.BlockingCollection%601> of strings that has a capacity of 1000 and uses a <xref:System.Collections.Concurrent.ConcurrentBag%601>:</span></span>  
  
```vb  
Dim bc = New BlockingCollection(Of String)(New ConcurrentBag(Of String()), 1000)  
```  
  
```csharp  
BlockingCollection<string> bc = new BlockingCollection<string>(new ConcurrentBag<string>(), 1000 );  
```  
  
 <span data-ttu-id="4b0a5-146">Дополнительные сведения см. в разделе [Практическое руководство. Добавление функций границы и блокировки в коллекцию](how-to-add-bounding-and-blocking.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-146">For more information, see [How to: Add Bounding and Blocking Functionality to a Collection](how-to-add-bounding-and-blocking.md).</span></span>  
  
## <a name="ienumerable-support"></a><span data-ttu-id="4b0a5-147">Поддержка интерфейса IEnumerable</span><span class="sxs-lookup"><span data-stu-id="4b0a5-147">IEnumerable Support</span></span>  
 <span data-ttu-id="4b0a5-148"><xref:System.Collections.Concurrent.BlockingCollection%601> предоставляет метод <xref:System.Collections.Concurrent.BlockingCollection%601.GetConsumingEnumerable%2A>, позволяющий потребителям использовать оператор `foreach` (`For Each` в Visual Basic) для удаления элементов коллекции до тех пор, пока коллекция не будет исчерпана (то есть достигнет состояния, в котором коллекция пуста и новые элементы не будут добавляться).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-148"><xref:System.Collections.Concurrent.BlockingCollection%601> provides a <xref:System.Collections.Concurrent.BlockingCollection%601.GetConsumingEnumerable%2A> method that enables consumers to use `foreach` (`For Each` in Visual Basic) to remove items until the collection is completed, which means it is empty and no more items will be added.</span></span> <span data-ttu-id="4b0a5-149">Дополнительные сведения см. в разделе [Практическое руководство. Использование оператора ForEach для удаления элементов в коллекции BlockingCollection](how-to-use-foreach-to-remove.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-149">For more information, see [How to: Use ForEach to Remove Items in a BlockingCollection](how-to-use-foreach-to-remove.md).</span></span>  
  
## <a name="using-many-blockingcollections-as-one"></a><span data-ttu-id="4b0a5-150">Использование нескольких коллекций BlockingCollection в качестве одной коллекции</span><span class="sxs-lookup"><span data-stu-id="4b0a5-150">Using Many BlockingCollections As One</span></span>  
 <span data-ttu-id="4b0a5-151">В сценариях, где потребителю необходимо одновременно извлекать элементы из нескольких коллекций, можно создавать массивы <xref:System.Collections.Concurrent.BlockingCollection%601> и использовать такие статические методы, как <xref:System.Collections.Concurrent.BlockingCollection%601.TakeFromAny%2A> и <xref:System.Collections.Concurrent.BlockingCollection%601.AddToAny%2A>, позволяющие добавлять и извлекать элементы любой коллекции в массиве.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-151">For scenarios in which a consumer needs to take items from multiple collections simultaneously, you can create arrays of <xref:System.Collections.Concurrent.BlockingCollection%601> and use the static methods such as <xref:System.Collections.Concurrent.BlockingCollection%601.TakeFromAny%2A> and <xref:System.Collections.Concurrent.BlockingCollection%601.AddToAny%2A> that will add to or take from any of the collections in the array.</span></span> <span data-ttu-id="4b0a5-152">Если одна из коллекций заблокирована, метод немедленно переходит к другой, пока не найдет коллекцию, способную выполнить операцию.</span><span class="sxs-lookup"><span data-stu-id="4b0a5-152">If one collection is blocking, the method immediately tries another until it finds one that can perform the operation.</span></span> <span data-ttu-id="4b0a5-153">Дополнительные сведения см. в разделе [Практическое руководство. Использование массивов для блокировки коллекций в конвейере](how-to-use-arrays-of-blockingcollections.md).</span><span class="sxs-lookup"><span data-stu-id="4b0a5-153">For more information, see [How to: Use Arrays of Blocking Collections in a Pipeline](how-to-use-arrays-of-blockingcollections.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4b0a5-154">См. также</span><span class="sxs-lookup"><span data-stu-id="4b0a5-154">See also</span></span>

- <xref:System.Collections.Concurrent?displayProperty=nameWithType>
- [<span data-ttu-id="4b0a5-155">Коллекции и структуры данных</span><span class="sxs-lookup"><span data-stu-id="4b0a5-155">Collections and Data Structures</span></span>](../index.md)
- [<span data-ttu-id="4b0a5-156">Потокобезопасные коллекции</span><span class="sxs-lookup"><span data-stu-id="4b0a5-156">Thread-Safe Collections</span></span>](index.md)
