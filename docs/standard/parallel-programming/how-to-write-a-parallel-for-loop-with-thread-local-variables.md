---
title: Практическое руководство. Написание цикла Parallel.For с локальными переменными потока
description: Ознакомьтесь с примером написания цикла Parallel.For в .NET, использующего локальные переменные потока для хранения и получения состояния каждой отдельной задачи цикла.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: 1e2dd0d554cdece23ac6d0e6b255ad70533236dc
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94826662"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="38c1a-103">Практическое руководство. Написание цикла Parallel.For с локальными переменными потока</span><span class="sxs-lookup"><span data-stu-id="38c1a-103">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="38c1a-104">В этом примере показано, как использовать локальные переменные потока для хранения и получения состояния каждой отдельной задачи, создаваемой циклом <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="38c1a-104">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="38c1a-105">Благодаря локальным переменным потока вы можете избежать дополнительной нагрузки при синхронизации большого количества доступов к общему состоянию.</span><span class="sxs-lookup"><span data-stu-id="38c1a-105">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="38c1a-106">Вместо записи в общий ресурс при каждой итерации вы вычисляете и сохраняете значение до тех пор, пока не будут выполнены все итерации для задачи.</span><span class="sxs-lookup"><span data-stu-id="38c1a-106">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="38c1a-107">После этого вы можете однократно записать итоговый результат в общий ресурс или передать его в другой метод.</span><span class="sxs-lookup"><span data-stu-id="38c1a-107">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="38c1a-108">Пример</span><span class="sxs-lookup"><span data-stu-id="38c1a-108">Example</span></span>  
 <span data-ttu-id="38c1a-109">В следующем примере выполняется вызов метода <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> для вычисления суммы значений в массиве, содержащем один миллион элементов.</span><span class="sxs-lookup"><span data-stu-id="38c1a-109">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="38c1a-110">Значение каждого элемента равно его индексу.</span><span class="sxs-lookup"><span data-stu-id="38c1a-110">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="38c1a-111">Два первых параметра каждого метода <xref:System.Threading.Tasks.Parallel.For%2A> задают начальное и конечное значения итерации.</span><span class="sxs-lookup"><span data-stu-id="38c1a-111">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="38c1a-112">В этой перегрузке метода третий параметр используется для инициализации локального состояния.</span><span class="sxs-lookup"><span data-stu-id="38c1a-112">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="38c1a-113">В этом контексте локальное состояние означает переменную, время существования которой начинается непосредственно перед первой итерацией цикла в текущем потоке и заканчивается сразу же после последней итерации.</span><span class="sxs-lookup"><span data-stu-id="38c1a-113">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="38c1a-114">Третий параметр имеет тип <xref:System.Func%601>, где `TResult` — это тип переменной для сохранения локального состояния потока.</span><span class="sxs-lookup"><span data-stu-id="38c1a-114">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="38c1a-115">Этот тип определяется аргументом универсального типа, переданным во время вызова универсального метода <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29>, в данном случае он равен <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="38c1a-115">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="38c1a-116">Этот аргумент типа сообщает компилятору тип временной переменной, которая будет использоваться для хранения локального состояния в потоке.</span><span class="sxs-lookup"><span data-stu-id="38c1a-116">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="38c1a-117">В этом примере выражение `() => 0` (или `Function() 0` в Visual Basic) инициализирует локальную переменную потока с нулевым значением.</span><span class="sxs-lookup"><span data-stu-id="38c1a-117">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="38c1a-118">Если бы аргумент универсального типа имел ссылочный тип или тип пользовательского значения, выражение выглядело бы следующим образом:</span><span class="sxs-lookup"><span data-stu-id="38c1a-118">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="38c1a-119">Четвертый параметр определяет логическую схему цикла.</span><span class="sxs-lookup"><span data-stu-id="38c1a-119">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="38c1a-120">Он должен быть делегатом или лямбда-выражением, сигнатура которого имеет значение `Func<int, ParallelLoopState, long, long>` в C# или `Func(Of Integer, ParallelLoopState, Long, Long)` в Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="38c1a-120">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="38c1a-121">Первый параметр представляет собой значение счетчика цикла для данной итерации цикла.</span><span class="sxs-lookup"><span data-stu-id="38c1a-121">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="38c1a-122">Второй является объектом <xref:System.Threading.Tasks.ParallelLoopState>, который можно использовать для выхода из цикла; данный объект предоставляется классом <xref:System.Threading.Tasks.Parallel> каждому экземпляру цикла.</span><span class="sxs-lookup"><span data-stu-id="38c1a-122">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="38c1a-123">Третий параметр представляет собой локальную переменную потока.</span><span class="sxs-lookup"><span data-stu-id="38c1a-123">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="38c1a-124">Последний параметр является типом возвращаемого значения.</span><span class="sxs-lookup"><span data-stu-id="38c1a-124">The last parameter is the return type.</span></span> <span data-ttu-id="38c1a-125">В данном случае этот тип имеет значение <xref:System.Int64>, так как именно его мы указали в аргументе типа <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="38c1a-125">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="38c1a-126">Эта переменная называется `subtotal` и возвращается лямбда-выражением.</span><span class="sxs-lookup"><span data-stu-id="38c1a-126">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="38c1a-127">Возвращаемое значение используется для инициализации `subtotal` на каждой последующей итерации цикла.</span><span class="sxs-lookup"><span data-stu-id="38c1a-127">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="38c1a-128">Этот последний параметр также можно представить себе в виде значения, которое передается в каждую итерацию, а после выполнения последней итерации передается в делегат `localFinally`.</span><span class="sxs-lookup"><span data-stu-id="38c1a-128">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="38c1a-129">Пятый параметр задает метод, который вызывается один раз после выполнения всех итераций в определенном потоке.</span><span class="sxs-lookup"><span data-stu-id="38c1a-129">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="38c1a-130">Тип входного аргумента опять соответствует аргументу типа метода <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> и типу, возвращаемому телом лямбда-выражения.</span><span class="sxs-lookup"><span data-stu-id="38c1a-130">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="38c1a-131">В данном примере это значение добавляется в переменную в области видимости класса потокобезопасным образом путем вызова метода <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="38c1a-131">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="38c1a-132">Благодаря использованию локальной переменной потока нам не пришлось выполнять запись в эту переменную класса при каждой итерации цикла.</span><span class="sxs-lookup"><span data-stu-id="38c1a-132">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="38c1a-133">См. дополнительные сведения о [лямбда-выражениях в PLINQ и TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="38c1a-133">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="38c1a-134">См. также</span><span class="sxs-lookup"><span data-stu-id="38c1a-134">See also</span></span>

- [<span data-ttu-id="38c1a-135">Параллелизм данных</span><span class="sxs-lookup"><span data-stu-id="38c1a-135">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="38c1a-136">Параллельное программирование</span><span class="sxs-lookup"><span data-stu-id="38c1a-136">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="38c1a-137">Библиотека параллельных задач (TPL)</span><span class="sxs-lookup"><span data-stu-id="38c1a-137">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="38c1a-138">Лямбда-выражения в PLINQ и TPL</span><span class="sxs-lookup"><span data-stu-id="38c1a-138">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
